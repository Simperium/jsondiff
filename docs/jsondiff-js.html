<!DOCTYPE html>  <html> <head>   <title>jsondiff.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               jsondiff.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Used to generate a diff between two JSON objects, and also transform a diff with respect to another diff</p>

<p>Generally when we diff two objects A and B, the diff can be thought of as, what are the operations needed to perform on A, to create an object identical to B
So B can be thought of as the target object, A is the origin object</p>

<h3>Example 1:</h3>

<pre><code>A = { 'num' : 5 }
B = { 'num' : 6 }
</code></pre>

<p>The <code>diff(A,B)</code> should specify an operation to add 1 to the value of the object key 'num'</p>

<p>We specify the diffs as a map of keys to operations.  An operation consists of 'o': specifies the kind/type of operation and 'v': a value or parameter for the operation
The 'v' is a parameter for the specified operation, in cases where the operation doesn't need a parameter, it might be omitted.
Currently this only happens when o = '-', which means, we are deleting a key, no parameter is necessary.</p>

<p>For the two example objects above, the diff would be:</p>

<pre><code>{
 'num' : {'o':'I', 'v':1}
}
</code></pre>

<p>For the key 'num', it defines an operation, the 'o' = 'I' specifies to treat the value of the subsequent 'v' as the parameter in an integer diff
For integer diffs,
  When generating the diff, to obtain the 'v' used in the operation, we just substract the value of the key of the origin object from the value of the key from the target object
  In other words, to get the 'v', we just do B.num - A.num, or 6-5</p>

<p>If we then applied this diff to A, because the 'o' is 'I' for integer, we know to just add the value of 'v' to A.num to get 6</p>

<h3>Example 2:</h3>

<pre><code>A = { 'numbers' : [1, 3, 2, 3, 4],
      'name' : 'Ted'
     }
B = { 'numbers' : [1, 2, 3, 4],
      'name' : 'Red'
     }
</code></pre>

<p>The <code>diff(A,B)</code> should be two main operations, one to somehow rearrange the array in numbers, to match the second array.  There are a number of different ways we could do this.
And the second should be to change the first letter of T to R in name - we don't care exactly how since DiffMatchPatch will take care of it. The value of the operation then is just the output of DMP.</p>

<p>Diff for array</p>

<p>When generating the diff, we see that the value of numbers is an array so we will call <code>list_diff()</code> to generate the diff for that portion.</p>

<pre><code>a = [1, 3, 2, 3, 4]
b = [1, 2, 3, 4]
</code></pre>

<p>The most naive approach we could do is to compare directly each index of the array, and when it is different, add an operation to change the value for that index.</p>

<p>For the above, we could do a series of operations like,</p>

<pre><code>Change a[1] to 2,
Change a[2] to 3,
Change a[3] to 4,
Delete a[4]
</code></pre>

<p>But the most efficient thing we could do is just to delete a[1]
We can optimize the operations generated by doing some work beforehand, like removing the common prefix/suffixes.
If we remove the common prefix/suffix, the resulting arrays are:</p>

<pre><code>[3]
[]
</code></pre>

<p>Now if we do the diff, we know we only need to delete 3 (a[1])</p>

<p>There are many more optimizations on <a href="http://neil.fraser.name/writing/diff/">Neil Fraser's page</a>, but currently that is the only one we do.</p>

<p>The delete a[1] will look like: '1' : {'o':'-'}
We use similar notation for arrays as objects. Where the keys are indexes.
That says at array index 1, we have a delete operation ('o' = '-'), since it is delete there is no parameter and no 'v'
That is the output of the <code>list_diff()</code> then, {'1': {'o' : '-'}}
When we apply that diff to array a, we know to go to index 1, do that operation (delete)</p>

<p>Back to the example, the diff for the 'numbers' key will first be 'o':'L' , with 'v', the value being the output of the <code>list_diff()</code> function.
That portion of the diff for 'numbers' will look like:</p>

<pre><code>{'numbers' : {'o':'L',
              'v': [output of list diff]
             }
}
</code></pre>

<p>or</p>

<pre><code>{'numbers' : {'o':'L',
              'v': {'1': {'o' : '-'}}
             }
}
</code></pre>

<p>Now we move on to the next key, 'name'.  We check the value and see that it is a string. For strings we automatically use diffmatchpatch.
When generating the diff, we set 'o' to 'd', so we know later to use DMP, and the value 'v' is the output of DMP diff (in DMP terms generating a delta)</p>

<p>This looks like:</p>

<pre><code>{'o':'d', 'v':'-1\t+R\t=2'}
</code></pre>

<p>So the diff for the 'name' key is:</p>

<pre><code>{'name': {'o':'d', 'v':'-1\t+R\t=2'}}
</code></pre>

<p>Now the diff for the whole object is all the diffs for all the keys.</p>

<pre><code>{'numbers' : {'o': 'L', 'v': {'1': {'o': '-'}}},
 'name'    : {'o': 'd', 'v': '-1\t+R\t=2'}}
</code></pre>

<p>We can use that as a parameter to <code>apply_obj_diff(A, diff)</code>, which would apply the above diff to object A (defined at top of example),
The output of that <code>apply_obj_diff(A, diff)</code> then should be an object identical to B.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h3>Main documentation</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">jsondiff</span>
  <span class="vi">@dmp = </span><span class="k">new</span> <span class="nx">diff_match_patch</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h3>Helper functions</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Return the number of entries in an object</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">entries: </span><span class="nf">(obj) -&gt;</span>
    <span class="nv">n = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">obj</span>
      <span class="nx">n</span><span class="o">++</span>
    <span class="nx">n</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Get the type properly, javascripts <code>typeof</code> is broken, see <a href="">http://javascript.crockford.com/remedial.html</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">typeOf: </span><span class="nf">(value) -&gt;</span>
    <span class="nv">s = </span><span class="k">typeof</span> <span class="nx">value</span>
    <span class="k">if</span> <span class="nx">s</span> <span class="o">is</span> <span class="s1">&#39;object&#39;</span>
      <span class="k">if</span> <span class="nx">value</span>
        <span class="k">if</span> <span class="k">typeof</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="s1">&#39;number&#39;</span> <span class="o">and</span>
          <span class="k">typeof</span> <span class="nx">value</span><span class="p">.</span><span class="nx">splice</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span> <span class="o">and</span>
          <span class="o">not</span> <span class="nx">value</span><span class="p">.</span><span class="nx">propertyIsEnumerable</span> <span class="s1">&#39;length&#39;</span>
            <span class="nv">s = </span><span class="s1">&#39;array&#39;</span>
      <span class="k">else</span>
        <span class="nv">s = </span><span class="s1">&#39;null&#39;</span>
    <span class="k">return</span> <span class="nx">s</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Return a deep copy of the object</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">deepCopy: </span><span class="nf">(obj) -&gt;</span>
    <span class="k">if</span> <span class="nb">Object</span><span class="o">::</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;[object Array]&#39;</span>
      <span class="nv">out = </span><span class="p">[]</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">obj</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
        <span class="nx">out</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">callee</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="k">return</span> <span class="nx">out</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">obj</span> <span class="o">is</span> <span class="s1">&#39;object&#39;</span>
      <span class="nv">out = </span><span class="p">{}</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">of</span> <span class="nx">obj</span>
        <span class="nx">out</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">callee</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="k">return</span> <span class="nx">out</span>
    <span class="k">return</span> <span class="nx">obj</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Deep equals comparison</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">equals: </span><span class="nf">(a, b) -&gt;</span>
    <span class="nv">typea = </span><span class="nx">@typeOf</span> <span class="nx">a</span>
    <span class="k">if</span> <span class="nx">typea</span> <span class="o">!=</span> <span class="nx">@typeOf</span> <span class="nx">b</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="k">if</span> <span class="nx">typea</span> <span class="o">is</span> <span class="s1">&#39;array&#39;</span>
      <span class="k">return</span> <span class="nx">@list_equals</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">typea</span> <span class="o">is</span> <span class="s1">&#39;object&#39;</span>
      <span class="k">return</span> <span class="nx">@object_equals</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="nx">a</span> <span class="o">is</span> <span class="nx">b</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Given two arrays, returns true if all elements of array are equal</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">list_equals: </span><span class="nf">(a, b) -&gt;</span>
    <span class="nv">alength = </span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">if</span> <span class="nx">alength</span> <span class="o">!=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">alength</span><span class="p">]</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">@equals</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="k">return</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Given two objects, returns true if both objects have same set of keys and values</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">object_equals: </span><span class="nf">(a, b) -&gt;</span>
    <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">a</span>
      <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">key</span> <span class="k">of</span> <span class="nx">b</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">false</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">@equals</span> <span class="nx">a</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">b</span>
      <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">key</span> <span class="k">of</span> <span class="nx">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="k">return</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Returns the length of common elements at beginning of two arrays</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_common_prefix: </span><span class="nf">(a, b) -&gt;</span>
    <span class="nv">minlen = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">minlen</span><span class="p">]</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">@equals</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="nx">i</span>
    <span class="k">return</span> <span class="nx">minlen</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Returns the length of common elements at end of two arrays</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_common_suffix: </span><span class="nf">(a, b) -&gt;</span>
    <span class="nv">lena = </span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span>
    <span class="nv">lenb = </span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span>
    <span class="nv">minlen = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">if</span> <span class="nx">minlen</span> <span class="o">is</span> <span class="mi">0</span>
      <span class="k">return</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">minlen</span><span class="p">]</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">@equals</span> <span class="nx">a</span><span class="p">[</span><span class="nx">lena</span><span class="o">-</span><span class="nx">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="nx">lenb</span><span class="o">-</span><span class="nx">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="nx">i</span>
    <span class="k">return</span> <span class="nx">minlen</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Compare two arrays and generate a diff object to be applied to an array.
For arrays we treat them like objects, in an object we have explicit mapping of keys : values.
The same format is used for arrays, where we replace the key with the index.</p>

<p>For example, if we have the objects:</p>

<pre><code>A = { 'num1' : 4, 'num2' : 7 }
B = { 'num1' : 8, 'num2' : 2 }
</code></pre>

<p>The <code>diff(A,B)</code> would be</p>

<pre><code>{ 'num1' : {'o':'I', 'v':4},
  'num2' : {'o':'I', 'v':-5} }
</code></pre>

<p>Similarly, if we have an array instead with the same values:</p>

<pre><code>A = [4, 7]
B = [8, 2]
</code></pre>

<p>The diff would be:</p>

<pre><code>{ '0' : {'o':'I', 'v':4},
  '1' : {'o':'I', 'v':-5} }
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">list_diff: </span><span class="nf">(a, b) -&gt;</span>
    <span class="nv">diffs = </span><span class="p">{}</span>
    <span class="nv">lena = </span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span>
    <span class="nv">lenb = </span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span>

    <span class="nv">prefix_len = </span><span class="nx">@_common_prefix</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span>
    <span class="nv">suffix_len = </span><span class="nx">@_common_suffix</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span>

    <span class="nv">a = </span><span class="nx">a</span><span class="p">[</span><span class="nx">prefix_len</span><span class="p">...</span><span class="nx">lena</span><span class="o">-</span><span class="nx">suffix_len</span><span class="p">]</span>
    <span class="nv">b = </span><span class="nx">b</span><span class="p">[</span><span class="nx">prefix_len</span><span class="p">...</span><span class="nx">lenb</span><span class="o">-</span><span class="nx">suffix_len</span><span class="p">]</span>

    <span class="nv">lena = </span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span>
    <span class="nv">lenb = </span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span>

    <span class="nv">maxlen = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span> <span class="nx">lena</span><span class="p">,</span> <span class="nx">lenb</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Iterate over both arrays</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="nx">maxlen</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">lena</span> <span class="o">and</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">lenb</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>If values aren't equal we set the value to be the output of the diff</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="o">not</span> <span class="nx">@equals</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
          <span class="nx">diffs</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="nx">prefix_len</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@diff</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">lena</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>array b doesn't have this element so remove it</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">diffs</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="nx">prefix_len</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;o&#39;</span><span class="o">:</span><span class="s1">&#39;-&#39;</span><span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">lenb</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>array a doesn't have this element so add it</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">diffs</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="nx">prefix_len</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;o&#39;</span><span class="o">:</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="o">:</span><span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">]}</span>

    <span class="k">return</span> <span class="nx">diffs</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Compare two objects and generate a diff object to be applied to an object (dictionary).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">object_diff: </span><span class="nf">(a, b) -&gt;</span>
    <span class="nv">diffs = </span><span class="p">{}</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">a</span><span class="o">?</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">b</span><span class="o">?</span> <span class="k">then</span> <span class="k">return</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">a</span>
      <span class="k">if</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">b</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Both objects have the same key, if the values aren't equal, set the value to tbe the output of the diff</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="o">not</span> <span class="nx">@equals</span> <span class="nx">a</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
          <span class="nx">diffs</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@diff</span> <span class="nx">a</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Object a has this key but object b doesn't, remove from a</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">diffs</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;o&#39;</span><span class="o">:</span><span class="s1">&#39;-&#39;</span><span class="p">}</span>
    <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">b</span>
      <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">key</span> <span class="k">of</span> <span class="nx">a</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Object b has this key but object a doesn't, add to a</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">diffs</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;o&#39;</span><span class="o">:</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="o">:</span><span class="nx">b</span><span class="p">[</span><span class="nx">key</span><span class="p">]}</span>

    <span class="k">return</span> <span class="nx">diffs</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>This is intended to be used by internal functions to automatically generate
the correct operations for a value based on the type.
diff(a,b) returns an operation object, such that when the operation is performed on a, the result is b.
An operation object is</p>

<pre><code>{'o':(operation type), 'v':(operation parameter value)}
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">diff: </span><span class="nf">(a, b) -&gt;</span>
    <span class="k">if</span> <span class="nx">@equals</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span>
      <span class="k">return</span> <span class="p">{}</span>
    <span class="nv">typea = </span><span class="nx">@typeOf</span> <span class="nx">a</span>
    <span class="k">if</span> <span class="nx">typea</span> <span class="o">!=</span> <span class="nx">@typeOf</span> <span class="nx">b</span>
      <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;o&#39;</span><span class="o">:</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="o">:</span><span class="nx">b</span> <span class="p">}</span>

    <span class="k">switch</span> <span class="nx">typea</span>
      <span class="k">when</span> <span class="s1">&#39;boolean&#39;</span>  <span class="k">then</span> <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;o&#39;</span><span class="o">:</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="o">:</span> <span class="nx">b</span><span class="p">}</span>
      <span class="k">when</span> <span class="s1">&#39;number&#39;</span>   <span class="k">then</span> <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;o&#39;</span><span class="o">:</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="o">:</span> <span class="nx">b</span><span class="o">-</span><span class="nx">a</span><span class="p">}</span>
      <span class="k">when</span> <span class="s1">&#39;array&#39;</span>    <span class="k">then</span> <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;o&#39;</span><span class="o">:</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="o">:</span> <span class="nx">@list_diff</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">}</span>
      <span class="k">when</span> <span class="s1">&#39;object&#39;</span>   <span class="k">then</span> <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;o&#39;</span><span class="o">:</span> <span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="o">:</span> <span class="nx">@object_diff</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">}</span>
      <span class="k">when</span> <span class="s1">&#39;string&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Use diffmatchpatch here for comparing strings</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">diffs = </span><span class="nx">jsondiff</span><span class="p">.</span><span class="nx">dmp</span><span class="p">.</span><span class="nx">diff_main</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span>
        <span class="k">if</span> <span class="nx">diffs</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">2</span>
          <span class="nx">jsondiff</span><span class="p">.</span><span class="nx">dmp</span><span class="p">.</span><span class="nx">diff_cleanupEfficiency</span> <span class="nx">diffs</span>
        <span class="k">if</span> <span class="nx">diffs</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
          <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;o&#39;</span><span class="o">:</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="o">:</span> <span class="nx">jsondiff</span><span class="p">.</span><span class="nx">dmp</span><span class="p">.</span><span class="nx">diff_toDelta</span> <span class="nx">diffs</span><span class="p">}</span>

    <span class="k">return</span> <span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Applies a diff object (which consists of a map of keys to operations) to an array (<code>s</code>) and
returns a new list with the operations in <code>diffs</code> applied to it</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">apply_list_diff: </span><span class="nf">(s, diffs) -&gt;</span>
    <span class="nv">patched = </span><span class="nx">@deepCopy</span> <span class="nx">s</span>
    <span class="nv">indexes = </span><span class="p">[]</span>
    <span class="nv">deleted = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Sort the keys (which are array indexes) so we can process them in order</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">diffs</span>
      <span class="nx">indexes</span><span class="p">.</span><span class="nx">push</span> <span class="nx">key</span>
      <span class="nx">indexes</span><span class="p">.</span><span class="nx">sort</span><span class="p">()</span>

    <span class="k">for</span> <span class="nx">index</span> <span class="k">in</span> <span class="nx">indexes</span>
      <span class="nv">op = </span><span class="nx">diffs</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Resulting index may be shifted depending if there were delete
operations before the current index.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">shift = </span><span class="p">[</span><span class="nx">x</span> <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">deleted</span> <span class="k">when</span> <span class="nx">x</span> <span class="o">&lt;=</span> <span class="nx">index</span><span class="p">].</span><span class="nx">length</span>
      <span class="nv">s_index = </span><span class="nx">index</span> <span class="o">-</span> <span class="nx">shift</span>

      <span class="k">switch</span> <span class="nx">op</span><span class="p">.</span><span class="nx">o</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Insert new value at index</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">when</span> <span class="s1">&#39;+&#39;</span>
          <span class="nx">patched</span><span class="p">[</span><span class="nx">s_index</span><span class="p">..</span><span class="nx">s_index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">op</span><span class="p">.</span><span class="nx">v</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Delete value at index</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">when</span> <span class="s1">&#39;-&#39;</span>
          <span class="nx">patched</span><span class="p">[</span><span class="nx">s_index</span><span class="p">..</span><span class="nx">s_index</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Replace value at index</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">when</span> <span class="s1">&#39;r&#39;</span>
          <span class="nx">patched</span><span class="p">[</span><span class="nx">s_index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">op</span><span class="p">.</span><span class="nx">v</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Integer, add the difference to current value</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">when</span> <span class="s1">&#39;I&#39;</span>
          <span class="nx">patched</span><span class="p">[</span><span class="nx">s_index</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">op</span><span class="p">.</span><span class="nx">v</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>List, apply the diff operations to the current array</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">when</span> <span class="s1">&#39;L&#39;</span>
          <span class="nx">patched</span><span class="p">[</span><span class="nx">s_index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@apply_list_diff</span> <span class="nx">patched</span><span class="p">[</span><span class="nx">s_index</span><span class="p">],</span> <span class="nx">op</span><span class="p">.</span><span class="nx">v</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Object, apply the diff operations to the current object</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">when</span> <span class="s1">&#39;O&#39;</span>
          <span class="nx">patched</span><span class="p">[</span><span class="nx">s_index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@apply_object_diff</span> <span class="nx">patched</span><span class="p">[</span><span class="nx">s_index</span><span class="p">],</span> <span class="nx">op</span><span class="p">.</span><span class="nx">v</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>String, apply the patch using diffmatchpatch</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">when</span> <span class="s1">&#39;d&#39;</span>
          <span class="nv">dmp_diffs = </span><span class="nx">jsondiff</span><span class="p">.</span><span class="nx">dmp</span><span class="p">.</span><span class="nx">diff_fromDelta</span> <span class="nx">patched</span><span class="p">[</span><span class="nx">s_index</span><span class="p">],</span> <span class="nx">op</span><span class="p">.</span><span class="nx">v</span>
          <span class="nv">dmp_patches = </span><span class="nx">jsondiff</span><span class="p">.</span><span class="nx">dmp</span><span class="p">.</span><span class="nx">patch_make</span> <span class="nx">patched</span><span class="p">[</span><span class="nx">s_index</span><span class="p">],</span> <span class="nx">dmp_diffs</span>
          <span class="nv">dmp_result = </span><span class="nx">jsondiff</span><span class="p">.</span><span class="nx">dmp</span><span class="p">.</span><span class="nx">patch_apply</span> <span class="nx">dmp_patches</span><span class="p">,</span> <span class="nx">patched</span><span class="p">[</span><span class="nx">s_index</span><span class="p">]</span>
          <span class="nx">patched</span><span class="p">[</span><span class="nx">s_index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">dmp_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="nx">patched</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Applies a diff object (which consists of a map of keys to operations) to an object (<code>s</code>) and
returns a new object with the operations in <code>diffs</code> applied to it</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">apply_object_diff: </span><span class="nf">(s, diffs) -&gt;</span>
    <span class="nv">patched = </span><span class="nx">@deepCopy</span> <span class="nx">s</span>
    <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">op</span> <span class="k">of</span> <span class="nx">diffs</span>
      <span class="k">switch</span> <span class="nx">op</span><span class="p">.</span><span class="nx">o</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Add new key/value</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">when</span> <span class="s1">&#39;+&#39;</span>
          <span class="nx">patched</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">op</span><span class="p">.</span><span class="nx">v</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Delete a key</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">when</span> <span class="s1">&#39;-&#39;</span>
          <span class="k">delete</span> <span class="nx">patched</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Replace the value for key</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">when</span> <span class="s1">&#39;r&#39;</span>
          <span class="nx">patched</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">op</span><span class="p">.</span><span class="nx">v</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Integer, add the difference to current value</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">when</span> <span class="s1">&#39;I&#39;</span>
          <span class="nx">patched</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">op</span><span class="p">.</span><span class="nx">v</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>List, apply the diff operations to the current array</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">when</span> <span class="s1">&#39;L&#39;</span>
          <span class="nx">patched</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@apply_list_diff</span> <span class="nx">patched</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">op</span><span class="p">.</span><span class="nx">v</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Object, apply the diff operations to the current object</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">when</span> <span class="s1">&#39;O&#39;</span>
          <span class="nx">patched</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@apply_object_diff</span> <span class="nx">patched</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">op</span><span class="p">.</span><span class="nx">v</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>String, apply the patch using diffmatchpatch</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">when</span> <span class="s1">&#39;d&#39;</span>
          <span class="nv">dmp_diffs = </span><span class="nx">jsondiff</span><span class="p">.</span><span class="nx">dmp</span><span class="p">.</span><span class="nx">diff_fromDelta</span> <span class="nx">patched</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">op</span><span class="p">.</span><span class="nx">v</span>
          <span class="nv">dmp_patches = </span><span class="nx">jsondiff</span><span class="p">.</span><span class="nx">dmp</span><span class="p">.</span><span class="nx">patch_make</span> <span class="nx">patched</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">dmp_diffs</span>
          <span class="nv">dmp_result = </span><span class="nx">jsondiff</span><span class="p">.</span><span class="nx">dmp</span><span class="p">.</span><span class="nx">patch_apply</span> <span class="nx">dmp_patches</span><span class="p">,</span> <span class="nx">patched</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
          <span class="nx">patched</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">dmp_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="nx">patched</span>

  <span class="nv">transform_list_diff: </span><span class="nf">(ad, bd, s) -&gt;</span>
    <span class="nv">ad_new = </span><span class="p">{}</span>
    <span class="nv">b_inserts = </span><span class="p">[]</span>
    <span class="nv">b_deletes = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">own</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">op</span> <span class="k">of</span> <span class="nx">bd</span>
      <span class="k">if</span> <span class="nx">op</span><span class="p">.</span><span class="nx">o</span> <span class="o">is</span> <span class="s1">&#39;+&#39;</span> <span class="k">then</span> <span class="nx">b_inserts</span><span class="p">.</span><span class="nx">push</span> <span class="nx">index</span>
      <span class="k">if</span> <span class="nx">op</span><span class="p">.</span><span class="nx">o</span> <span class="o">is</span> <span class="s1">&#39;-&#39;</span> <span class="k">then</span> <span class="nx">b_deletes</span><span class="p">.</span><span class="nx">push</span> <span class="nx">index</span>
    <span class="k">for</span> <span class="nx">own</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">op</span> <span class="k">of</span> <span class="nx">ad</span>
      <span class="nv">shift_r = </span><span class="p">[</span><span class="nx">x</span> <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">b_inserts</span> <span class="k">when</span> <span class="nx">x</span> <span class="o">&lt;=</span> <span class="nx">index</span><span class="p">].</span><span class="nx">length</span>
      <span class="nv">shift_l = </span><span class="p">[</span><span class="nx">x</span> <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">b_deletes</span> <span class="k">when</span> <span class="nx">x</span> <span class="o">&lt;=</span> <span class="nx">index</span><span class="p">].</span><span class="nx">length</span>

      <span class="nv">index = </span><span class="nx">index</span> <span class="o">+</span> <span class="nx">shift_r</span> <span class="o">-</span> <span class="nx">shift_l</span>
      <span class="nv">sindex = </span><span class="nb">String</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span>

      <span class="nx">ad_new</span><span class="p">[</span><span class="nx">sindex</span><span class="p">]</span> <span class="o">=</span> <span class="nx">op</span>
      <span class="k">if</span> <span class="nx">index</span> <span class="k">of</span> <span class="nx">bd</span>
        <span class="k">if</span> <span class="nx">op</span><span class="p">.</span><span class="nx">o</span> <span class="o">is</span> <span class="s1">&#39;+&#39;</span> <span class="o">and</span> <span class="nx">bd</span><span class="p">.</span><span class="nx">index</span><span class="p">.</span><span class="nx">op</span> <span class="o">is</span> <span class="s1">&#39;+&#39;</span>
          <span class="k">continue</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">op</span><span class="p">.</span><span class="nx">o</span> <span class="o">is</span> <span class="s1">&#39;-&#39;</span> <span class="o">and</span> <span class="nx">bd</span><span class="p">.</span><span class="nx">index</span><span class="p">.</span><span class="nx">op</span> <span class="o">is</span> <span class="s1">&#39;-&#39;</span>
          <span class="k">delete</span> <span class="nx">ad_new</span><span class="p">[</span><span class="nx">sindex</span><span class="p">]</span>
        <span class="k">else</span>
          <span class="nv">diff = </span><span class="nx">@transform_object_diff</span><span class="p">({</span><span class="nx">sindex</span><span class="o">:</span><span class="nx">op</span><span class="p">},</span> <span class="p">{</span><span class="nx">sindex</span><span class="o">:</span><span class="nx">bd</span><span class="p">.</span><span class="nx">index</span><span class="p">.</span><span class="nx">op</span><span class="p">},</span> <span class="nx">s</span><span class="p">)</span>
          <span class="nx">ad_new</span><span class="p">[</span><span class="nx">sindex</span><span class="p">]</span> <span class="o">=</span> <span class="nx">diff</span><span class="p">[</span><span class="nx">sindex</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">ad_new</span>

  <span class="nv">transform_object_diff: </span><span class="nf">(ad, bd, s) -&gt;</span>
    <span class="nv">ad_new = </span><span class="nx">@deepCopy</span> <span class="nx">ad</span>
    <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">aop</span> <span class="k">of</span> <span class="nx">ad</span>
      <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">key</span> <span class="k">of</span> <span class="nx">bd</span><span class="p">)</span> <span class="k">then</span> <span class="k">continue</span>

      <span class="nv">sk = </span><span class="nx">s</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="nv">bop = </span><span class="nx">bd</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>

      <span class="k">if</span> <span class="nx">aop</span><span class="p">.</span><span class="nx">o</span> <span class="o">is</span> <span class="s1">&#39;+&#39;</span> <span class="o">and</span> <span class="nx">bop</span><span class="p">.</span><span class="nx">o</span> <span class="o">is</span> <span class="s1">&#39;+&#39;</span>
        <span class="k">if</span> <span class="nx">@equals</span> <span class="nx">aop</span><span class="p">.</span><span class="nx">v</span><span class="p">,</span> <span class="nx">bop</span><span class="p">.</span><span class="nx">v</span>
          <span class="k">delete</span> <span class="nx">ad_new</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
        <span class="k">else</span>
          <span class="nx">ad_new</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@diff</span> <span class="nx">bop</span><span class="p">.</span><span class="nx">v</span><span class="p">,</span> <span class="nx">aop</span><span class="p">.</span><span class="nx">v</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">aop</span><span class="p">.</span><span class="nx">o</span> <span class="o">is</span> <span class="s1">&#39;-&#39;</span> <span class="o">and</span> <span class="nx">bop</span><span class="p">.</span><span class="nx">o</span> <span class="o">is</span> <span class="s1">&#39;-&#39;</span>
        <span class="k">delete</span> <span class="nx">ad_new</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">bop</span><span class="p">.</span><span class="nx">o</span> <span class="o">is</span> <span class="s1">&#39;-&#39;</span> <span class="o">and</span> <span class="nx">aop</span><span class="p">.</span><span class="nx">o</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">]</span>
        <span class="nx">ad_new</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;o&#39;</span><span class="o">:</span><span class="s1">&#39;+&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="nx">aop</span><span class="p">.</span><span class="nx">o</span> <span class="o">is</span> <span class="s1">&#39;O&#39;</span>
          <span class="nx">ad_new</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nv">v = </span><span class="nx">@apply_object_diff</span> <span class="nx">sk</span><span class="p">,</span> <span class="nx">aop</span><span class="p">.</span><span class="nx">v</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">aop</span><span class="p">.</span><span class="nx">o</span> <span class="o">is</span> <span class="s1">&#39;L&#39;</span>
          <span class="nx">ad_new</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nv">v = </span><span class="nx">@apply_list_diff</span> <span class="nx">sk</span><span class="p">,</span> <span class="nx">aop</span><span class="p">.</span><span class="nx">v</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">aop</span><span class="p">.</span><span class="nx">o</span> <span class="o">is</span> <span class="s1">&#39;I&#39;</span>
          <span class="nx">ad_new</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nv">v = </span><span class="nx">sk</span> <span class="o">+</span> <span class="nx">aop</span><span class="p">.</span><span class="nx">v</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">aop</span><span class="p">.</span><span class="nx">o</span> <span class="o">is</span> <span class="s1">&#39;d&#39;</span>
          <span class="nv">dmp_diffs = </span><span class="nx">jsondiff</span><span class="p">.</span><span class="nx">dmp</span><span class="p">.</span><span class="nx">diff_fromDelta</span> <span class="nx">sk</span><span class="p">,</span> <span class="nx">aop</span><span class="p">.</span><span class="nx">v</span>
          <span class="nv">dmp_patches = </span><span class="nx">jsondiff</span><span class="p">.</span><span class="nx">dmp</span><span class="p">.</span><span class="nx">patch_make</span> <span class="nx">sk</span><span class="p">,</span> <span class="nx">dmp_diffs</span>
          <span class="nv">dmp_result = </span><span class="nx">jsondiff</span><span class="p">.</span><span class="nx">dmp</span><span class="p">.</span><span class="nx">patch_apply</span> <span class="nx">dmp_patches</span><span class="p">,</span> <span class="nx">sk</span>
          <span class="nx">ad_new</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nv">v = </span><span class="nx">dmp_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">aop</span><span class="p">.</span><span class="nx">o</span> <span class="o">is</span> <span class="s1">&#39;O&#39;</span> <span class="o">and</span> <span class="nx">bop</span><span class="p">.</span><span class="nx">o</span> <span class="o">is</span> <span class="s1">&#39;O&#39;</span>
        <span class="nx">ad_new</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;o&#39;</span><span class="o">:</span><span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="o">:</span> <span class="nx">@transform_object_diff</span> <span class="nx">aop</span><span class="p">.</span><span class="nx">v</span><span class="p">,</span> <span class="nx">bop</span><span class="p">.</span><span class="nx">v</span><span class="p">,</span> <span class="nx">sk</span><span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">aop</span><span class="p">.</span><span class="nx">o</span> <span class="o">is</span> <span class="s1">&#39;L&#39;</span> <span class="o">and</span> <span class="nx">bop</span><span class="p">.</span><span class="nx">o</span> <span class="o">is</span> <span class="s1">&#39;L&#39;</span>
        <span class="nx">ad_new</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;o&#39;</span><span class="o">:</span><span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="o">:</span> <span class="nx">@transform_list_diff</span> <span class="nx">aop</span><span class="p">.</span><span class="nx">v</span><span class="p">,</span> <span class="nx">bop</span><span class="p">.</span><span class="nx">v</span><span class="p">,</span> <span class="nx">sk</span><span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">aop</span><span class="p">.</span><span class="nx">o</span> <span class="o">is</span> <span class="s1">&#39;d&#39;</span> <span class="o">and</span> <span class="nx">bop</span><span class="p">.</span><span class="nx">o</span> <span class="o">is</span> <span class="s1">&#39;d&#39;</span>
        <span class="k">delete</span> <span class="nx">ad_new</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
        <span class="nv">a_patches = </span><span class="nx">jsondiff</span><span class="p">.</span><span class="nx">dmp</span><span class="p">.</span><span class="nx">patch_make</span> <span class="nx">sk</span><span class="p">,</span> <span class="nx">jsondiff</span><span class="p">.</span><span class="nx">dmp</span><span class="p">.</span><span class="nx">diff_fromDelta</span> <span class="nx">sk</span><span class="p">,</span> <span class="nx">aop</span><span class="p">.</span><span class="nx">v</span>
        <span class="nv">b_patches = </span><span class="nx">jsondiff</span><span class="p">.</span><span class="nx">dmp</span><span class="p">.</span><span class="nx">patch_make</span> <span class="nx">sk</span><span class="p">,</span> <span class="nx">jsondiff</span><span class="p">.</span><span class="nx">dmp</span><span class="p">.</span><span class="nx">diff_fromDelta</span> <span class="nx">sk</span><span class="p">,</span> <span class="nx">bop</span><span class="p">.</span><span class="nx">v</span>
        <span class="nv">b_text = </span><span class="p">(</span><span class="nx">jsondiff</span><span class="p">.</span><span class="nx">dmp</span><span class="p">.</span><span class="nx">patch_apply</span> <span class="nx">b_patches</span><span class="p">,</span> <span class="nx">sk</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nv">ab_text = </span><span class="p">(</span><span class="nx">jsondiff</span><span class="p">.</span><span class="nx">dmp</span><span class="p">.</span><span class="nx">patch_apply</span> <span class="nx">a_patches</span><span class="p">,</span> <span class="nx">b_text</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">ab_text</span> <span class="o">!=</span> <span class="nx">b_text</span>
          <span class="nv">dmp_diffs = </span><span class="nx">jsondiff</span><span class="p">.</span><span class="nx">dmp</span><span class="p">.</span><span class="nx">diff_main</span> <span class="nx">b_text</span><span class="p">,</span> <span class="nx">ab_text</span>
          <span class="k">if</span> <span class="nx">dmp_diffs</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">2</span>
            <span class="nx">jsondiff</span><span class="p">.</span><span class="nx">dmp</span><span class="p">.</span><span class="nx">diff_cleanupEfficiency</span> <span class="nx">dmp_diffs</span>
          <span class="k">if</span> <span class="nx">dmp_diffs</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="nx">ad_new</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;o&#39;</span><span class="o">:</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="o">:</span><span class="nx">jsondiff</span><span class="p">.</span><span class="nx">dmp</span><span class="p">.</span><span class="nx">diff_toDelta</span> <span class="nx">dmp_diffs</span><span class="p">}</span>

      <span class="k">return</span> <span class="nx">ad_new</span>

<span class="nb">window</span><span class="p">.</span><span class="nv">jsondiff = </span><span class="nx">jsondiff</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 